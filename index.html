<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH5 Trainer Booking System</title>
<style>
  :root {
    --primary: #3b82f6;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --gray: #6b7280;
    --light-gray: #f3f4f6;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f9fafb;
    line-height: 1.6;
    color: #1f2937;
  }
  
  .hidden { display: none !important; }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
  }
  
  .card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
  }
  
  button, input, select, textarea {
    font-size: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    min-height: 44px;
  }
  
  button {
    background: var(--primary);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  button.secondary {
    background: #6b7280;
  }
  
  button.danger {
    background: var(--danger);
  }
  
  .w-full { width: 100%; }
  .mb-2 { margin-bottom: 0.5rem; }
  .mb-4 { margin-bottom: 1rem; }
  .text-center { text-align: center; }
  
  .status-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 4px;
  }
  
  .chat-box {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    padding: 1rem;
    border-radius: 8px;
    background: #f9fafb;
    margin-bottom: 1rem;
  }
  
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    text-align: center;
  }
  
  .calendar-day {
    padding: 12px 8px;
    border-radius: 8px;
    cursor: pointer;
    background: white;
    border: 1px solid #e5e7eb;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  
  .calendar-day.weekend {
    background: #f8fafc;
    color: #6b7280;
  }
  
  .calendar-day.today {
    background: #dbeafe;
    border-color: var(--primary);
  }
  
  .calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    text-align: center;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }
  
  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .form-group {
    margin-bottom: 1rem;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
  }
  
  .checkbox-group, .radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 0.5rem;
  }
  
  .checkbox-group label, .radio-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: normal;
    cursor: pointer;
  }
  
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .summary-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .summary-card h3 {
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }
  
  .summary-card .number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
  }
  
  .nav-bar {
    background: white;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 1.5rem;
  }
  
  .nav-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: between;
    align-items: center;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  @media (max-width: 768px) {
    .container {
      padding: 0.5rem;
    }
    
    .card {
      padding: 1rem;
    }
    
    .summary-grid {
      grid-template-columns: 1fr;
    }
    
    .calendar-day {
      min-height: 60px;
      padding: 8px 4px;
      font-size: 0.875rem;
    }
  }
</style>
</head>
<body>

<!-- Navigation -->
<div class="nav-bar">
  <div class="nav-content">
    <h1>RH5 Trainer Booking System</h1>
    <div class="user-info">
      <span id="user-display">ผู้เยี่ยมชม</span>
      <button id="logout-btn" class="hidden">ออกจากระบบ</button>
    </div>
  </div>
</div>

<!-- Login Page -->
<div id="login-page" class="container">
  <div class="card" style="max-width: 400px; margin: 2rem auto;">
    <h2 style="text-align: center; margin-bottom: 1.5rem;">เข้าสู่ระบบ</h2>
    
    <div class="form-group">
      <label for="username">ชื่อผู้ใช้</label>
      <input type="text" id="username" class="w-full" placeholder="กรอกชื่อผู้ใช้">
    </div>
    
    <div class="form-group">
      <label for="password">รหัสผ่าน</label>
      <input type="password" id="password" class="w-full" placeholder="กรอกรหัสผ่าน">
    </div>
    
    <button id="login-btn" class="w-full mb-2">เข้าสู่ระบบ</button>
    
    <div style="text-align: center; font-size: 0.875rem; color: #6b7280;">
      <p>ตัวอย่างผู้ใช้:</p>
      <p>admin / admin123 (ผู้ดูแลระบบ)</p>
      <p>staff1 / staff123 (พนักงาน)</p>
      <p>lect1 / lect123 (วิทยากร)</p>
    </div>
  </div>
</div>

<!-- Dashboard Page -->
<div id="dashboard-page" class="container hidden">
  <!-- Banner -->
  <div class="card">
    <h2 id="banner-text" style="text-align: center;">RH5 Trainer Booking System</h2>
  </div>

  <!-- Summary Cards -->
  <div class="summary-grid" id="summary-cards">
    <!-- Summary cards will be generated by JavaScript -->
  </div>

  <!-- Calendar -->
  <div class="card">
    <h3 style="margin-bottom: 1rem;">ปฏิทินการจอง</h3>
    <div class="calendar-header">
      <div>อา</div>
      <div>จ</div>
      <div>อ</div>
      <div>พ</div>
      <div>พฤ</div>
      <div>ศ</div>
      <div>ส</div>
    </div>
    <div class="calendar" id="calendar">
      <!-- Calendar will be generated by JavaScript -->
    </div>
    
    <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span class="status-dot" style="background: #ef4444;"></span>
        <span>วันไม่ว่าง</span>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span class="status-dot" style="background: #f59e0b;"></span>
        <span>วันถูกบล็อค</span>
      </div>
    </div>
  </div>

  <!-- CTA Button -->
  <div style="text-align: center; margin: 2rem 0;">
    <button id="book-cta" style="padding: 1rem 2rem; font-size: 1.125rem;">จองคิววิทยากร</button>
  </div>

  <!-- Admin Features -->
  <div id="admin-features" class="hidden">
    <!-- User Management -->
    <div class="card">
      <h3 style="margin-bottom: 1rem;">จัดการผู้ใช้</h3>
      <button id="add-user-btn" class="mb-4">เพิ่มผู้ใช้</button>
      <div id="user-list">
        <!-- User list will be generated by JavaScript -->
      </div>
    </div>

    <!-- Banner Management -->
    <div class="card">
      <h3 style="margin-bottom: 1rem;">จัดการ Banner</h3>
      <div class="form-group">
        <input type="text" id="banner-input" class="w-full" placeholder="ข้อความ banner">
      </div>
      <button id="save-banner-btn">บันทึก Banner</button>
    </div>
  </div>

  <!-- Staff Features -->
  <div id="staff-features" class="hidden">
    <!-- Invitation PDF -->
    <div class="card">
      <h3 style="margin-bottom: 1rem;">สร้างบัตรเชิญ</h3>
      <div class="form-group">
        <label for="booking-select">เลือกการจอง</label>
        <select id="booking-select" class="w-full"></select>
      </div>
      <button id="generate-invitation">ดาวน์โหลด PDF</button>
    </div>
  </div>

  <!-- Live Chat -->
  <div class="card">
    <h3 style="margin-bottom: 1rem;">Live Chat</h3>
    <div class="chat-box" id="chat-messages"></div>
    <div class="form-group">
      <input type="text" id="chat-input" class="w-full" placeholder="พิมพ์ข้อความ...">
    </div>
    <button id="chat-send" class="w-full">ส่งข้อความ</button>
  </div>
</div>

<!-- Booking Modal -->
<div id="booking-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 style="margin-bottom: 1.5rem;">สร้างการจอง</h3>
    
    <form id="booking-form">
      <div class="form-group">
        <label for="booking-date">วันที่</label>
        <input type="date" id="booking-date" class="w-full" required>
      </div>
      
      <div class="form-group">
        <label for="booking-start">เวลาเริ่มต้น</label>
        <input type="time" id="booking-start" class="w-full" required>
      </div>
      
      <div class="form-group">
        <label for="booking-end">เวลาสิ้นสุด</label>
        <input type="time" id="booking-end" class="w-full" required>
      </div>
      
      <div class="form-group">
        <label for="booking-zone">Zone</label>
        <select id="booking-zone" class="w-full" required>
          <option value="">เลือก Zone</option>
          <option value="ราชบุรี">ราชบุรี</option>
          <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
          <option value="ภูเก็ต">ภูเก็ต</option>
          <option value="หาดใหญ่">หาดใหญ่</option>
          <option value="สมุทรสาคร">สมุทรสาคร</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>กลุ่มผู้เข้าร่วม</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="group" value="BM"> BM</label>
          <label><input type="checkbox" name="group" value="CISA"> CISA</label>
          <label><input type="checkbox" name="group" value="CFSA"> CFSA</label>
          <label><input type="checkbox" name="group" value="Wealth"> Wealth</label>
          <label><input type="checkbox" name="group" value="Other"> Other</label>
        </div>
      </div>
      
      <div class="form-group">
        <label>ประเภทการอบรม</label>
        <div class="radio-group">
          <label><input type="radio" name="training-type" value="F2F" checked> F2F</label>
          <label><input type="radio" name="training-type" value="Online"> Online</label>
        </div>
      </div>
      
      <div class="form-group" id="location-field">
        <label for="booking-location">สถานที่</label>
        <input type="text" id="booking-location" class="w-full" placeholder="ระบุสถานที่">
      </div>
      
      <div class="form-group">
        <label for="booking-topic">หัวข้อ</label>
        <input type="text" id="booking-topic" class="w-full" placeholder="หัวข้อการอบรม" required>
      </div>
      
      <div class="form-group">
        <label for="booking-purpose">วัตถุประสงค์/รายละเอียด</label>
        <textarea id="booking-purpose" class="w-full" rows="3" placeholder="วัตถุประสงค์และรายละเอียดการอบรม" required></textarea>
      </div>
      
      <div class="form-group">
        <label for="booking-attendees">จำนวนผู้เข้าอบรม</label>
        <input type="number" id="booking-attendees" class="w-full" min="1" max="1000" placeholder="ระบุจำนวนผู้เข้าอบรม" required>
      </div>
      
      <div class="form-group">
        <label for="booking-speaker">วิทยากร</label>
        <select id="booking-speaker" class="w-full">
          <option value="">เลือกวิทยากร</option>
          <option value="อ.อาร์ม">อ.อาร์ม</option>
          <option value="อ.ฟ้า">อ.ฟ้า</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="booking-contact-name">ชื่อผู้ประสานงาน</label>
        <input type="text" id="booking-contact-name" class="w-full" placeholder="ชื่อผู้ประสานงาน" required>
      </div>
      
      <div class="form-group">
        <label for="booking-contact-position">ตำแหน่ง</label>
        <input type="text" id="booking-contact-position" class="w-full" placeholder="ตำแหน่ง">
      </div>
      
      <div class="form-group">
        <label for="booking-contact-phone">เบอร์โทรศัพท์</label>
        <input type="tel" id="booking-contact-phone" class="w-full" placeholder="เบอร์โทรศัพท์" required>
      </div>
      
      <div class="form-group" id="status-field">
        <label for="booking-status">สถานะ</label>
        <select id="booking-status" class="w-full">
          <option value="pending">Pending</option>
          <option value="accepted">Accepted</option>
          <option value="rejected">Rejected</option>
          <option value="blocked">Blocked</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button type="button" id="booking-cancel" class="secondary" style="flex: 1;">ยกเลิก</button>
        <button type="submit" id="booking-submit" style="flex: 1;">สร้างการจอง</button>
      </div>
    </form>
  </div>
</div>

<script>
// ========= CONFIGURATION =========
const USERS_KEY = 'rh5_users';
const BOOKINGS_KEY = 'rh5_bookings';
const SESSION_KEY = 'rh5_session';
const CHAT_KEY = 'rh5_chat';
const BANNER_KEY = 'rh5_banner';

// ========= INITIAL DATA =========
function initializeData() {
  // Initialize users
  if (!localStorage.getItem(USERS_KEY)) {
    const users = [
      { username: 'admin', password: 'admin123', role: 'admin', displayName: 'ผู้ดูแลระบบ' },
      { username: 'staff1', password: 'staff123', role: 'staff', displayName: 'พนักงาน 1' },
      { username: 'lect1', password: 'lect123', role: 'lecturer', displayName: 'วิทยากร 1' }
    ];
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }
  
  // Initialize banner
  if (!localStorage.getItem(BANNER_KEY)) {
    localStorage.setItem(BANNER_KEY, 'RH5 Trainer Booking System');
  }
}

// ========= SESSION MANAGEMENT =========
function saveSession(user) {
  localStorage.setItem(SESSION_KEY, JSON.stringify(user));
}

function getSession() {
  return JSON.parse(localStorage.getItem(SESSION_KEY));
}

function clearSession() {
  localStorage.removeItem(SESSION_KEY);
}

function logout() {
  clearSession();
  document.getElementById('dashboard-page').classList.add('hidden');
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('user-display').textContent = 'ผู้เยี่ยมชม';
  document.getElementById('logout-btn').classList.add('hidden');
}

// ========= LOGIN =========
document.getElementById('login-btn').addEventListener('click', function() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  if (!username || !password) {
    alert('กรุณากรอกชื่อผู้ใช้และรหัสผ่าน');
    return;
  }
  
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    saveSession(user);
    loadDashboard();
  } else {
    alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
  }
});

// ========= DASHBOARD =========
function loadDashboard() {
  const session = getSession();
  if (!session) return;
  
  document.getElementById('login-page').classList.add('hidden');
  document.getElementById('dashboard-page').classList.remove('hidden');
  document.getElementById('user-display').textContent = session.displayName;
  document.getElementById('logout-btn').classList.remove('hidden');
  
  // Show/hide features based on role
  const isAdmin = session.role === 'admin';
  const isStaff = session.role === 'staff';
  
  document.getElementById('admin-features').classList.toggle('hidden', !isAdmin);
  document.getElementById('staff-features').classList.toggle('hidden', !isStaff);
  
  renderSummary();
  renderCalendar();
  renderUsers();
  renderBanner();
  renderChat();
  renderBookingSelect();
}

// ========= SUMMARY CARDS =========
function renderSummary() {
  const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]');
  const now = new Date();
  const currentMonth = now.getMonth() + 1;
  const currentYear = now.getFullYear();
  
  // Filter bookings for current month and year
  const monthlyBookings = bookings.filter(booking => {
    const bookingDate = new Date(booking.date);
    return bookingDate.getMonth() + 1 === currentMonth && 
           bookingDate.getFullYear() === currentYear;
  });
  
  const yearlyBookings = bookings.filter(booking => {
    const bookingDate = new Date(booking.date);
    return bookingDate.getFullYear() === currentYear;
  });
  
  // Calculate total attendees
  const monthlyAttendees = monthlyBookings.reduce((total, booking) => 
    total + (parseInt(booking.attendees) || 0), 0);
  
  const yearlyAttendees = yearlyBookings.reduce((total, booking) => 
    total + (parseInt(booking.attendees) || 0), 0);
  
  // Calculate status counts
  const pendingCount = bookings.filter(b => b.status === 'pending').length;
  const acceptedCount = bookings.filter(b => b.status === 'accepted').length;
  const rejectedCount = bookings.filter(b => b.status === 'rejected').length;
  
  document.getElementById('summary-cards').innerHTML = `
    <div class="summary-card">
      <h3>จำนวนงานที่รีเควส</h3>
      <div class="number">${monthlyBookings.length}</div>
      <div>เดือนนี้</div>
    </div>
    <div class="summary-card">
      <h3>จำนวนงานที่รีเควส</h3>
      <div class="number">${yearlyBookings.length}</div>
      <div>ปีนี้</div>
    </div>
    <div class="summary-card">
      <h3>จำนวนผู้เข้าอบรม</h3>
      <div class="number">${monthlyAttendees}</div>
      <div>เดือนนี้</div>
    </div>
    <div class="summary-card">
      <h3>จำนวนผู้เข้าอบรม</h3>
      <div class="number">${yearlyAttendees}</div>
      <div>ปีนี้</div>
    </div>
    <div class="summary-card">
      <h3>Pending</h3>
      <div class="number">${pendingCount}</div>
    </div>
    <div class="summary-card">
      <h3>Accepted</h3>
      <div class="number">${acceptedCount}</div>
    </div>
    <div class="summary-card">
      <h3>Rejected</h3>
      <div class="number">${rejectedCount}</div>
    </div>
  `;
}

// ========= CALENDAR =========
function renderCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  // Get bookings
  const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]');
  
  // Add empty cells for days before the first day of month
  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-day';
    calendar.appendChild(emptyCell);
  }
  
  // Add days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const dayCell = document.createElement('div');
    const dateStr = `${year}-${month + 1}-${day}`;
    
    // Check if today
    if (day === today) {
      dayCell.classList.add('today');
    }
    
    // Check if weekend
    const dayOfWeek = new Date(year, month, day).getDay();
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      dayCell.classList.add('weekend');
    }
    
    // Check for bookings on this day
    const dayBookings = bookings.filter(booking => booking.date === dateStr);
    const hasBlocked = dayBookings.some(booking => booking.status === 'blocked');
    const hasBooking = dayBookings.some(booking => 
      ['pending', 'accepted'].includes(booking.status));
    
    dayCell.className = 'calendar-day';
    dayCell.innerHTML = `
      <div>${day}</div>
      <div>
        ${hasBlocked ? '<span class="status-dot" style="background: #f59e0b;"></span>' : ''}
        ${hasBooking && !hasBlocked ? '<span class="status-dot" style="background: #ef4444;"></span>' : ''}
      </div>
    `;
    
    // Add click event to show booking details
    dayCell.addEventListener('click', () => showDayDetails(dateStr, dayBookings));
    
    calendar.appendChild(dayCell);
  }
}

function showDayDetails(date, bookings) {
  if (bookings.length === 0) {
    alert(`${date}\n\nไม่มีข้อมูลการจอง`);
    return;
  }
  
  let message = `วันที่: ${date}\n\n`;
  bookings.forEach(booking => {
    message += `• ${booking.topic} (${booking.zone})\n`;
    message += `  เวลา: ${booking.start} - ${booking.end}\n`;
    message += `  สถานะ: ${booking.status}\n\n`;
  });
  
  alert(message);
}

// ========= BOOKING SYSTEM =========
document.getElementById('book-cta').addEventListener('click', function() {
  const session = getSession();
  if (!session) {
    alert('กรุณาเข้าสู่ระบบก่อน');
    return;
  }
  
  openBookingModal();
});

function openBookingModal() {
  const session = getSession();
  const now = new Date();
  
  // Set default values
  document.getElementById('booking-date').valueAsDate = now;
  document.getElementById('booking-start').value = '09:00';
  document.getElementById('booking-end').value = '10:00';
  document.getElementById('booking-zone').value = '';
  document.querySelectorAll('input[name="group"]').forEach(cb => cb.checked = false);
  document.querySelector('input[name="training-type"][value="F2F"]').checked = true;
  document.getElementById('booking-location').value = '';
  document.getElementById('booking-topic').value = '';
  document.getElementById('booking-purpose').value = '';
  document.getElementById('booking-attendees').value = '';
  document.getElementById('booking-speaker').value = '';
  document.getElementById('booking-contact-name').value = session.displayName || '';
  document.getElementById('booking-contact-position').value = '';
  document.getElementById('booking-contact-phone').value = '';
  
  // Set status field based on user role
  const statusField = document.getElementById('status-field');
  const statusSelect = document.getElementById('booking-status');
  
  if (session.role === 'admin') {
    statusField.classList.remove('hidden');
    statusSelect.value = 'pending';
  } else {
    statusField.classList.add('hidden');
    statusSelect.value = 'pending';
  }
  
  document.getElementById('booking-modal').classList.remove('hidden');
}

document.getElementById('booking-cancel').addEventListener('click', function() {
  document.getElementById('booking-modal').classList.add('hidden');
});

// Show/hide location field based on training type
document.querySelectorAll('input[name="training-type"]').forEach(radio => {
  radio.addEventListener('change', function() {
    document.getElementById('location-field').classList.toggle('hidden', this.value !== 'F2F');
  });
});

document.getElementById('booking-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const session = getSession();
  if (!session) {
    alert('กรุณาเข้าสู่ระบบก่อน');
    return;
  }
  
  // Get form values
  const date = document.getElementById('booking-date').value;
  const start = document.getElementById('booking-start').value;
  const end = document.getElementById('booking-end').value;
  const zone = document.getElementById('booking-zone').value;
  const groups = Array.from(document.querySelectorAll('input[name="group"]:checked'))
    .map(cb => cb.value);
  const trainingType = document.querySelector('input[name="training-type"]:checked').value;
  const location = document.getElementById('booking-location').value;
  const topic = document.getElementById('booking-topic').value;
  const purpose = document.getElementById('booking-purpose').value;
  const attendees = document.getElementById('booking-attendees').value;
  const speaker = document.getElementById('booking-speaker').value;
  const contactName = document.getElementById('booking-contact-name').value;
  const contactPosition = document.getElementById('booking-contact-position').value;
  const contactPhone = document.getElementById('booking-contact-phone').value;
  let status = document.getElementById('booking-status').value;
  
  // Validation
  if (!date || !start || !end) {
    alert('กรุณากรอกวันที่และเวลาให้ครบถ้วน');
    return;
  }
  
  if (!zone) {
    alert('กรุณาเลือก Zone');
    return;
  }
  
  if (!topic) {
    alert('กรุณากรอกหัวข้อการอบรม');
    return;
  }
  
  if (!purpose) {
    alert('กรุณากรอกวัตถุประสงค์/รายละเอียด');
    return;
  }
  
  if (!attendees || attendees < 1 || attendees > 1000) {
    alert('กรุณากรอกจำนวนผู้เข้าอบรม (1-1000 คน)');
    return;
  }
  
  if (!contactName || !contactPhone) {
    alert('กรุณากรอกข้อมูลผู้ประสานงานให้ครบถ้วน');
    return;
  }
  
  // Check for time conflicts
  const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]');
  const conflict = bookings.some(booking => 
    booking.date === date && 
    booking.status !== 'rejected' &&
    ((start >= booking.start && start < booking.end) || 
     (end > booking.start && end <= booking.end) ||
     (start <= booking.start && end >= booking.end))
  );
  
  if (conflict) {
    alert('วันและเวลานี้มีการจองแล้ว กรุณาเลือกเวลาอื่น');
    return;
  }
  
  // Non-admin users can only create pending bookings
  if (session.role !== 'admin') {
    status = 'pending';
  }
  
  // Create booking object
  const booking = {
    id: Date.now().toString(),
    date,
    start,
    end,
    zone,
    groups,
    trainingType,
    location,
    topic,
    purpose,
    attendees: parseInt(attendees),
    speaker,
    contact: {
      name: contactName,
      position: contactPosition,
      phone: contactPhone
    },
    status,
    createdBy: session.username,
    createdAt: new Date().toISOString()
  };
  
  // Save booking
  bookings.push(booking);
  localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
  
  // Close modal and refresh
  document.getElementById('booking-modal').classList.add('hidden');
  alert('สร้างการจองเรียบร้อยแล้ว');
  
  renderSummary();
  renderCalendar();
  renderBookingSelect();
});

// ========= USER MANAGEMENT =========
function renderUsers() {
  const userList = document.getElementById('user-list');
  userList.innerHTML = '';
  
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
  
  users.forEach((user, index) => {
    const userDiv = document.createElement('div');
    userDiv.className = 'card';
    userDiv.innerHTML = `
      <div style="display: flex; justify-content: between; align-items: center;">
        <div>
          <strong>${user.username}</strong> (${user.role})
          <div>${user.displayName}</div>
        </div>
        <div>
          <button onclick="editUser(${index})" class="secondary">แก้ไข</button>
          ${user.role !== 'admin' ? `<button onclick="deleteUser(${index})" class="danger">ลบ</button>` : ''}
        </div>
      </div>
    `;
    userList.appendChild(userDiv);
  });
}

document.getElementById('add-user-btn').addEventListener('click', function() {
  const username = prompt('ชื่อผู้ใช้:');
  if (!username) return;
  
  const password = prompt('รหัสผ่าน:');
  if (!password) return;
  
  const role = prompt('บทบาท (admin, staff, lecturer):');
  if (!role || !['admin', 'staff', 'lecturer'].includes(role)) {
    alert('บทบาทต้องเป็น admin, staff, หรือ lecturer');
    return;
  }
  
  const displayName = prompt('ชื่อแสดง:') || username;
  
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
  users.push({ username, password, role, displayName });
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  
  renderUsers();
});

window.editUser = function(index) {
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
  const user = users[index];
  
  const newUsername = prompt('ชื่อผู้ใช้:', user.username);
  if (!newUsername) return;
  
  const newPassword = prompt('รหัสผ่าน (เว้นว่างหากไม่ต้องการเปลี่ยน):');
  const newRole = prompt('บทบาท:', user.role);
  const newDisplayName = prompt('ชื่อแสดง:', user.displayName);
  
  users[index] = {
    username: newUsername,
    password: newPassword || user.password,
    role: newRole || user.role,
    displayName: newDisplayName || newUsername
  };
  
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  renderUsers();
};

window.deleteUser = function(index) {
  if (!confirm('แน่ใจว่าต้องการลบผู้ใช้นี้?')) return;
  
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
  users.splice(index, 1);
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
  
  renderUsers();
};

// ========= BANNER MANAGEMENT =========
function renderBanner() {
  const banner = localStorage.getItem(BANNER_KEY) || 'RH5 Trainer Booking System';
  document.getElementById('banner-text').textContent = banner;
  document.getElementById('banner-input').value = banner;
}

document.getElementById('save-banner-btn').addEventListener('click', function() {
  const bannerText = document.getElementById('banner-input').value;
  if (!bannerText) {
    alert('กรุณากรอกข้อความ banner');
    return;
  }
  
  localStorage.setItem(BANNER_KEY, bannerText);
  renderBanner();
  alert('บันทึก banner เรียบร้อยแล้ว');
});

// ========= LIVE CHAT =========
function renderChat() {
  const chatMessages = document.getElementById('chat-messages');
  const chat = JSON.parse(localStorage.getItem(CHAT_KEY) || '[]');
  
  chatMessages.innerHTML = chat.map(msg => 
    `<div><strong>${msg.user}:</strong> ${msg.text}</div>`
  ).join('');
  
  // Scroll to bottom
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

document.getElementById('chat-send').addEventListener('click', function() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  
  if (!text) return;
  
  const session = getSession();
  if (!session) {
    alert('กรุณาเข้าสู่ระบบก่อนส่งข้อความ');
    return;
  }
  
  const chat = JSON.parse(localStorage.getItem(CHAT_KEY) || '[]');
  chat.push({
    user: session.displayName,
    text,
    timestamp: new Date().toISOString()
  });
  
  // Keep only last 50 messages
  if (chat.length > 50) {
    chat.splice(0, chat.length - 50);
  }
  
  localStorage.setItem(CHAT_KEY, JSON.stringify(chat));
  input.value = '';
  renderChat();
});

// Send message on Enter key
document.getElementById('chat-input').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    document.getElementById('chat-send').click();
  }
});

// ========= INVITATION PDF =========
function renderBookingSelect() {
  const select = document.getElementById('booking-select');
  select.innerHTML = '';
  
  const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]');
  const session = getSession();
  
  // Filter bookings based on user role
  const userBookings = session.role === 'admin' 
    ? bookings 
    : bookings.filter(b => b.createdBy === session.username);
  
  userBookings.forEach(booking => {
    const option = document.createElement('option');
    option.value = booking.id;
    option.textContent = `${booking.date} ${booking.start}-${booking.end}: ${booking.topic}`;
    select.appendChild(option);
  });
}

document.getElementById('generate-invitation').addEventListener('click', function() {
  const select = document.getElementById('booking-select');
  const bookingId = select.value;
  
  if (!bookingId) {
    alert('กรุณาเลือกการจอง');
    return;
  }
  
  const bookings = JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]');
  const booking = bookings.find(b => b.id === bookingId);
  
  if (!booking) {
    alert('ไม่พบข้อมูลการจอง');
    return;
  }
  
  // Create simple PDF content (in a real app, you would use a PDF library)
  const content = `
    บัตรเชิญเข้าร่วมอบรม
    ====================
    
    หัวข้อ: ${booking.topic}
    วันที่: ${booking.date}
    เวลา: ${booking.start} - ${booking.end}
    สถานที่: ${booking.location || 'ออนไลน์'}
   
    
    ข้อมูลผู้ประสานงาน:
    - ชื่อ: ${booking.contact.name}
    - ตำแหน่ง: ${booking.contact.position}
    - โทร: ${booking.contact.phone}
    
    รายละเอียด:
    ${booking.purpose}
  `;
  
  // Create and download text file as a simple PDF alternative
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `invitation-${booking.date}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// ========= EVENT LISTENERS =========
document.getElementById('logout-btn').addEventListener('click', logout);

// ========= INITIALIZATION =========
document.addEventListener('DOMContentLoaded', function() {
  initializeData();
  
  // Check if user is already logged in
  const session = getSession();
  if (session) {
    loadDashboard();
  }
});
</script>
</body>
</html>
