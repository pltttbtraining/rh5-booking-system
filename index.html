<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RH5 Trainer booking system - Public Dashboard</title>

  <!-- Tailwind CSS from CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Small custom styles */
    .day-cell { min-height: 88px; } /* touch-friendly */
    .dot { width: 12px; height: 12px; border-radius: 50%; display:inline-block; margin-left:6px; }
    /* ensure buttons at least 44px high (touch target) */
    .touch-btn { min-height: 44px; padding-top: 8px; padding-bottom: 8px; }
    /* calendar grid */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div class="max-w-7xl mx-auto p-4">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">RH5 Trainer booking system</h1>
        <p class="text-sm text-slate-500">Public Dashboard ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£</p>
      </div>

      <div class="flex items-center gap-3">
        <div id="userArea" class="text-sm"></div>
        <button id="ctaBooking" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-md px-4 touch-btn">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£</button>
        <button id="logoutBtn" class="hidden bg-gray-200 text-slate-700 rounded-md px-3 touch-btn">Logout</button>
      </div>
    </header>

    <!-- Main content: grid -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Calendar -->
      <section class="lg:col-span-2 bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium">Calendar ‚Äî ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
          <div class="flex items-center gap-2">
            <button id="prevMonth" class="px-3 py-1 rounded touch-btn bg-slate-100">‚Äπ</button>
            <div id="monthLabel" class="font-semibold"></div>
            <button id="nextMonth" class="px-3 py-1 rounded touch-btn bg-slate-100">‚Ä∫</button>
          </div>
        </div>

        <div class="text-xs text-slate-600 mb-2 grid grid-cols-7 gap-2">
          <div class="text-center font-semibold">‡∏≠‡∏≤</div>
          <div class="text-center font-semibold">‡∏à</div>
          <div class="text-center font-semibold">‡∏≠</div>
          <div class="text-center font-semibold">‡∏û</div>
          <div class="text-center font-semibold">‡∏û‡∏§</div>
          <div class="text-center font-semibold">‡∏®</div>
          <div class="text-center font-semibold">‡∏™</div>
        </div>

        <div id="calendar" class="calendar-grid"></div>
        <div class="mt-3 text-sm text-slate-600">
          <span class="inline-flex items-center mr-3"><span class="dot bg-red-500"></span>&nbsp;üî¥ ‡∏ß‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</span>
          <span class="inline-flex items-center mr-3"><span class="dot bg-yellow-400"></span>&nbsp;üü° ‡∏ß‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ</span>
          <span class="inline-flex items-center mr-3"><span class="dot bg-slate-400"></span>&nbsp;‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</span>
        </div>
      </section>

      <!-- Right: Summary Cards -->
      <aside class="space-y-4">
        <!-- Summary card: zones pie -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-medium mb-2">Total Bookings (by zone)</h3>
          <canvas id="pieZones" height="200"></canvas>
        </div>

        <!-- Bookings by month -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-medium mb-2">Bookings by Month (this month)</h3>
          <canvas id="barMonth" height="140"></canvas>
        </div>

        <!-- Bookings by year -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-medium mb-2">Bookings by Year (this year)</h3>
          <canvas id="barYear" height="140"></canvas>
        </div>

        <!-- Status cards -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-medium mb-3">Status Summary</h3>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="p-3 rounded border">
              <div class="text-sm text-slate-500">Pending</div>
              <div id="pendingCount" class="font-semibold text-slate-700">0</div>
            </div>
            <div class="p-3 rounded border">
              <div class="text-sm text-slate-500">Accepted</div>
              <div id="acceptedCount" class="font-semibold text-green-600">0</div>
            </div>
            <div class="p-3 rounded border">
              <div class="text-sm text-slate-500">Rejected</div>
              <div id="rejectedCount" class="font-semibold text-red-600">0</div>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <!-- Footer small -->
    <footer class="mt-6 text-xs text-slate-500">
      ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö: ‡πÉ‡∏ä‡πâ localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö session & booking ‚Äî ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö production (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ backend ‡∏à‡∏£‡∏¥‡∏á)
    </footer>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-semibold mb-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <div class="space-y-3">
        <div>
          <label class="text-sm text-slate-600">Username</label>
          <input id="loginUser" class="w-full border rounded px-3 py-2 mt-1" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Password</label>
          <input id="loginPass" type="password" class="w-full border rounded px-3 py-2 mt-1" />
        </div>
        <div class="flex justify-end gap-2 mt-2">
          <button id="loginCancel" class="px-4 py-2 touch-btn rounded border">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="loginSubmit" class="bg-indigo-600 text-white px-4 py-2 touch-btn rounded">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    /******************************************************************
     * RH5 Public Dashboard + Session Management
     * - localStorage keys:
     *     rh5_users        : array of users
     *     rh5_bookings     : array of bookings
     *     rh5_session      : { username, role, displayName, createdAt, lastActivity }
     *
     * Features implemented:
     *  - login/logout
     *  - session check on load
     *  - auto-logout after 30 minutes inactivity
     *  - public view vs logged-in routing (simple show/hide)
     *  - calendar with markers (red dot = booked, yellow dot = blocked)
     *  - charts: pie (zones), bar (month), bar (year)
     *  - sample initial data seeded if not present
     ******************************************************************/

    // -----------------------
    // Configuration / constants
    // -----------------------
    const SESSION_KEY = 'rh5_session';
    const USERS_KEY = 'rh5_users';
    const BOOKINGS_KEY = 'rh5_bookings';
    const AUTOLOGOUT_MINUTES = 30;
    const ZONES = ['Zone A','Zone B','Zone C']; // sample zones

    // -----------------------
    // Helper: seed initial data
    // -----------------------
    function seedInitialData() {
      if (!localStorage.getItem(USERS_KEY)) {
        const users = [
          { username: 'admin', password: 'admin123', role: 'admin', displayName: 'Administrator' },
          { username: 'staff1', password: 'staff123', role: 'staff', displayName: 'Staff - Jintana' },
          { username: 'lect1', password: 'lect123', role: 'lecturer', displayName: 'Lecturer - Somsak' }
        ];
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        console.log('Seeded users');
      }

      if (!localStorage.getItem(BOOKINGS_KEY)) {
        // sample booking structure:
        // { id, date: 'YYYY-MM-DD', zone, status: 'pending'|'accepted'|'rejected'|'blocked', title, createdBy }
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');

        const bookings = [
          // some booked days this month
          { id: 'b1', date: `${yyyy}-${mm}-05`, zone: 'Zone A', status: 'accepted', title: 'Training A', createdBy: 'staff1' },
          { id: 'b2', date: `${yyyy}-${mm}-12`, zone: 'Zone B', status: 'pending', title: 'Workshop B', createdBy: 'lect1' },
          { id: 'b3', date: `${yyyy}-${mm}-12`, zone: 'Zone C', status: 'accepted', title: 'Seminar C', createdBy: 'staff1' },
          { id: 'b4', date: `${yyyy}-${mm}-20`, zone: 'Zone A', status: 'rejected', title: 'Canceled D', createdBy: 'staff1' },
          // blocked day
          { id: 'blk1', date: `${yyyy}-${mm}-25`, zone: null, status: 'blocked', title: 'System Maintenance', createdBy: 'admin' },
          // previous month and next month examples
          { id: 'old1', date: `${yyyy}-${String(Math.max(1,today.getMonth())).padStart(2,'0')}-15`, zone: 'Zone B', status: 'accepted', title: 'Last Month Event', createdBy: 'staff1' },
          { id: 'fut1', date: `${yyyy}-${String(Math.min(12,today.getMonth()+2)).padStart(2,'0')}-08`, zone: 'Zone C', status: 'pending', title: 'Next Month Event', createdBy: 'lect1' },
        ];

        localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
        console.log('Seeded bookings');
      }
    }

    // -----------------------
    // Session management
    // -----------------------
    function saveSession(sessionObj) {
      sessionObj.lastActivity = Date.now();
      sessionObj.createdAt = sessionObj.createdAt || Date.now();
      localStorage.setItem(SESSION_KEY, JSON.stringify(sessionObj));
      updateUIForSession();
    }

    function clearSession() {
      localStorage.removeItem(SESSION_KEY);
      updateUIForSession();
    }

    function getSession() {
      const s = localStorage.getItem(SESSION_KEY);
      return s ? JSON.parse(s) : null;
    }

    // Login (simple, demo)
    function login(username, password) {
      const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
      const found = users.find(u => u.username === username && u.password === password);
      if (!found) return { ok:false, message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
      const sessionObj = { username: found.username, role: found.role, displayName: found.displayName, createdAt: Date.now(), lastActivity: Date.now() };
      saveSession(sessionObj);
      return { ok:true, session: sessionObj };
    }

    // Logout
    function logout() {
      clearSession();
      showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
      // show login CTA
      renderPublicView();
    }

    // Check session on load and route
    function checkSessionOnLoad() {
      const sess = getSession();
      if (!sess) {
        renderPublicView();
        return;
      }
      // check inactivity
      const elapsed = Date.now() - (sess.lastActivity || sess.createdAt || Date.now());
      if (elapsed > AUTOLOGOUT_MINUTES * 60 * 1000) {
        // expired
        clearSession();
        renderPublicView();
        showToast('Session ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (inactive) ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      } else {
        // active -> route to role dashboard (simple UI change)
        // update lastActivity
        sess.lastActivity = Date.now();
        localStorage.setItem(SESSION_KEY, JSON.stringify(sess));
        routeToRoleDashboard(sess.role);
      }
    }

    // update last activity on interactions
    function touchSessionActivity() {
      const sess = getSession();
      if (!sess) return;
      sess.lastActivity = Date.now();
      localStorage.setItem(SESSION_KEY, JSON.stringify(sess));
    }

    // Auto-logout checker
    setInterval(() => {
      const sess = getSession();
      if (!sess) return;
      const elapsed = Date.now() - (sess.lastActivity || sess.createdAt || Date.now());
      if (elapsed > AUTOLOGOUT_MINUTES * 60 * 1000) {
        logout();
        showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ');
      }
    }, 30 * 1000); // check every 30s

    // activity listeners to update lastActivity
    ['click','touchstart','keydown'].forEach(evt => {
      window.addEventListener(evt, () => {
        touchSessionActivity();
      }, { passive:true });
    });

    // -----------------------
    // UI helpers
    // -----------------------
    function updateUIForSession() {
      const sess = getSession();
      const userArea = document.getElementById('userArea');
      const logoutBtn = document.getElementById('logoutBtn');
      const cta = document.getElementById('ctaBooking');

      if (sess) {
        userArea.innerHTML = `<div class="text-sm">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${sess.displayName} (${sess.role})</div>`;
        logoutBtn.classList.remove('hidden');
        cta.textContent = '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£';
        // after login, route
        routeToRoleDashboard(sess.role);
      } else {
        userArea.innerHTML = `<div class="text-sm text-slate-600">‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°</div>`;
        logoutBtn.classList.add('hidden');
        cta.textContent = '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£';
        renderPublicView();
      }
    }

    function showLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('loginUser').focus();
    }
    function hideLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('loginUser').value = '';
      document.getElementById('loginPass').value = '';
    }

    function showToast(msg, ms=3000) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded shadow';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(()=> toast.remove(), ms);
    }

    // -----------------------
    // Booking data helpers
    // -----------------------
    function getBookings() {
      return JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]');
    }
    function saveBookings(arr) {
      localStorage.setItem(BOOKINGS_KEY, JSON.stringify(arr));
    }

    function addBooking(booking) {
      // booking must contain date (YYYY-MM-DD), zone or null, status
      const arr = getBookings();
      booking.id = 'b' + (Math.random().toString(36).slice(2,9));
      arr.push(booking);
      saveBookings(arr);
      refreshAll();
    }

    // -----------------------
    // Calendar rendering
    // -----------------------
    let calendarDate = new Date(); // current shown month

    function toYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    function renderCalendar() {
      const cal = document.getElementById('calendar');
      cal.innerHTML = '';
      const year = calendarDate.getFullYear();
      const month = calendarDate.getMonth();

      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      const startDayOfWeek = first.getDay(); // 0..6 (Sun..Sat)
      const daysInMonth = last.getDate();

      // blanks before first day
      for (let i=0;i<startDayOfWeek;i++) {
        const blank = document.createElement('div');
        blank.className = 'bg-transparent p-2';
        cal.appendChild(blank);
      }

      const bookings = getBookings();
      const bookingsByDate = bookings.reduce((acc, b) => {
        acc[b.date] = acc[b.date] || [];
        acc[b.date].push(b);
        return acc;
      }, {});

      for (let d=1; d<=daysInMonth; d++) {
        const dateObj = new Date(year, month, d);
        const ymd = toYMD(dateObj);
        const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
        const cell = document.createElement('div');
        cell.className = `day-cell border rounded p-2 bg-white flex flex-col justify-between`;
        if (isWeekend) {
          cell.classList.add('bg-slate-50');
        }

        // header: day number and dots
        const top = document.createElement('div');
        top.className = 'flex items-center justify-between';
        const dayNum = document.createElement('div');
        dayNum.className = 'font-medium text-sm';
        dayNum.textContent = d;
        top.appendChild(dayNum);

        // status dots
        const markers = document.createElement('div');
        const entries = bookingsByDate[ymd] || [];
        // priority: if any blocked -> show yellow; else if any booking accepted/pending -> red
        const hasBlocked = entries.some(e => e.status === 'blocked');
        const hasBooking = entries.some(e => ['accepted','pending','rejected'].includes(e.status));
        if (hasBlocked) {
          const dot = document.createElement('span');
          dot.className = 'dot bg-yellow-400';
          dot.title = 'üü° ‡∏ß‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ';
          markers.appendChild(dot);
        } else if (hasBooking) {
          const dot = document.createElement('span');
          dot.className = 'dot bg-red-500';
          dot.title = 'üî¥ ‡∏ß‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏°‡∏µ booking)';
          markers.appendChild(dot);
        }

        top.appendChild(markers);
        cell.appendChild(top);

        // middle: list some entries
        const mid = document.createElement('div');
        mid.className = 'text-xs text-slate-600 mt-2 flex-1';
        if (entries.length === 0) {
          mid.textContent = '‡∏ß‡πà‡∏≤‡∏á';
        } else {
          // show up to 2 entries
          entries.slice(0,2).forEach(e => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            const statusColor = (e.status === 'accepted') ? 'text-green-600' : (e.status === 'rejected' ? 'text-red-600' : 'text-slate-700');
            row.innerHTML = `<span class="${statusColor} text-xs font-semibold">${e.title}</span><span class="text-xs text-slate-400">(${e.zone||'‚Äî'})</span>`;
            mid.appendChild(row);
          });
          if (entries.length > 2) {
            const more = document.createElement('div');
            more.className = 'text-xs text-slate-400';
            more.textContent = `+${entries.length-2} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            mid.appendChild(more);
          }
        }
        cell.appendChild(mid);

        // footer: click to show details (simple alert)
        cell.addEventListener('click', (ev)=> {
          ev.stopPropagation();
          showDateDetails(ymd);
        });

        // weekend grey tint
        if (isWeekend) {
          cell.style.opacity = 0.9;
        }

        cal.appendChild(cell);
      }

      document.getElementById('monthLabel').textContent = calendarDate.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
    }

    function showDateDetails(ymd) {
      const bookings = getBookings().filter(b => b.date === ymd);
      if (bookings.length === 0) {
        alert(`${ymd}\n\n‡∏ß‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á`);
        return;
      }
      let msg = `${ymd}\n\n`;
      bookings.forEach(b => {
        msg += `‚Ä¢ ${b.title} ‚Äî ${b.zone || '‚Äî'} ‚Äî ${b.status} (by ${b.createdBy})\n`;
      });
      alert(msg);
    }

    // Calendar nav
    document.getElementById('prevMonth').addEventListener('click', ()=> {
      calendarDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth()-1, 1);
      renderCalendar();
    });
    document.getElementById('nextMonth').addEventListener('click', ()=> {
      calendarDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth()+1, 1);
      renderCalendar();
    });

    // -----------------------
    // Charts
    // -----------------------
    let pieChart = null, barMonthChart = null, barYearChart = null;

    function refreshCharts() {
      const bookings = getBookings();

      // Pie: zones proportion (only count non-blocked bookings that have zone)
      const zoneCounts = {};
      ZONES.forEach(z => zoneCounts[z] = 0);
      bookings.filter(b => b.zone).forEach(b => {
        if (zoneCounts[b.zone] !== undefined) zoneCounts[b.zone]++;
        else zoneCounts[b.zone] = (zoneCounts[b.zone] || 0) + 1;
      });

      const pieLabels = Object.keys(zoneCounts);
      const pieData = pieLabels.map(l => zoneCounts[l]);

      if (pieChart) pieChart.destroy();
      const ctxPie = document.getElementById('pieZones').getContext('2d');
      pieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
          labels: pieLabels,
          datasets: [{
            data: pieData,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });

      // Bookings by Month (this month) - show counts by day for current shown month
      const curY = calendarDate.getFullYear();
      const curM = calendarDate.getMonth();
      const daysInMonth = new Date(curY, curM+1, 0).getDate();
      const dailyCounts = new Array(daysInMonth).fill(0);
      bookings.forEach(b => {
        const d = new Date(b.date + 'T00:00:00');
        if (d.getFullYear() === curY && d.getMonth() === curM) {
          dailyCounts[d.getDate()-1] += 1;
        }
      });
      const labels = dailyCounts.map((_,i)=> String(i+1));
      if (barMonthChart) barMonthChart.destroy();
      const ctxBarM = document.getElementById('barMonth').getContext('2d');
      barMonthChart = new Chart(ctxBarM, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Bookings', data: dailyCounts }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });

      // Bookings by Year (this year) - counts per month
      const year = (new Date()).getFullYear();
      const monthlyCounts = new Array(12).fill(0);
      bookings.forEach(b => {
        const d = new Date(b.date + 'T00:00:00');
        if (d.getFullYear() === year) {
          monthlyCounts[d.getMonth()] += 1;
        }
      });
      const monthLabels = ['‡∏°.‡∏Ñ','‡∏Å.‡∏û','‡∏°‡∏µ.‡∏Ñ','‡πÄ‡∏°.‡∏¢','‡∏û.‡∏Ñ','‡∏°‡∏¥.‡∏¢','‡∏Å.‡∏Ñ','‡∏™.‡∏Ñ','‡∏Å.‡∏¢','‡∏ï.‡∏Ñ','‡∏û.‡∏¢','‡∏ò.‡∏Ñ'];
      if (barYearChart) barYearChart.destroy();
      const ctxBarY = document.getElementById('barYear').getContext('2d');
      barYearChart = new Chart(ctxBarY, {
        type: 'bar',
        data: { labels: monthLabels, datasets: [{ label: 'Bookings', data: monthlyCounts }] },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });

      // status cards
      const pending = bookings.filter(b => b.status === 'pending').length;
      const accepted = bookings.filter(b => b.status === 'accepted').length;
      const rejected = bookings.filter(b => b.status === 'rejected').length;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('acceptedCount').textContent = accepted;
      document.getElementById('rejectedCount').textContent = rejected;
    }

    // -----------------------
    // Public vs role dashboards (simple)
    // -----------------------
    function renderPublicView() {
      // Public: show calendar / charts but disable booking action
      // CTA should open login
      document.getElementById('ctaBooking').addEventListener('click', showLoginModal);
      document.getElementById('logoutBtn').classList.add('hidden');
      // Update user text
      updateUIForSession();
      refreshAll();
    }

    function routeToRoleDashboard(role) {
      // For demo, we simply show a toast and keep same dashboard,
      // but we can display role-specific content or redirect to separate pages.
      // Required: After login -> go to Dashboard according to role (Staff/Lecturer/Admin)
      showToast(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Dashboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${role}`, 2000);
      // change CTA: allow booking if staff/lecturer/admin? spec says after login go to dashboard by role.
      const cta = document.getElementById('ctaBooking');
      cta.removeEventListener('click', showLoginModal);
      // Example: only staff/lecturer/admin can create bookings (for demo, show a quick booking form)
      cta.textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
      cta.addEventListener('click', ()=> {
        showCreateBookingPrompt(role);
      });
      document.getElementById('logoutBtn').classList.remove('hidden');
      refreshAll();
    }

    function showCreateBookingPrompt(role) {
      // Quick prompt for demo: pick a date in shown month and create booking
      const date = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á booking (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 2025-10-05)\n*‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà');
      if (!date) return;
      const zone = prompt('Zone (Zone A / Zone B / Zone C):', 'Zone A');
      if (!zone) return;
      const title = prompt('Title (‡πÄ‡∏ä‡πà‡∏ô: Training):', 'Training');
      if (!title) return;
      // Basic validation: date format
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
        alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      const sess = getSession();
      if (!sess) { alert('‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const booking = { date, zone, status: 'pending', title, createdBy: sess.username };
      addBooking(booking);
      showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á booking ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: pending)');
    }

    // -----------------------
    // Refresh everything
    // -----------------------
    function refreshAll() {
      renderCalendar();
      refreshCharts();
      updateUIForSession();
    }

    // -----------------------
    // Event bindings
    // -----------------------
    document.getElementById('ctaBooking').addEventListener('click', showLoginModal);
    document.getElementById('loginCancel').addEventListener('click', hideLoginModal);
    document.getElementById('loginSubmit').addEventListener('click', ()=> {
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      if (!u || !p) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }
      const r = login(u,p);
      if (!r.ok) {
        showToast(r.message);
      } else {
        hideLoginModal();
        showToast('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        updateUIForSession();
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=> {
      logout();
    });

    // keyboard enter to submit login
    document.getElementById('loginPass').addEventListener('keydown', (e)=> {
      if (e.key === 'Enter') document.getElementById('loginSubmit').click();
    });

    // -----------------------
    // Init
    // -----------------------
    (function init() {
      seedInitialData();
      // set calendarDate to current month
      calendarDate = new Date();
      // initial render
      checkSessionOnLoad();
      // If no session, show public view
      if (!getSession()) {
        renderPublicView();
      }
      // ensure UI touch sizes
      document.querySelectorAll('button, input').forEach(el => {
        el.style.touchAction = 'manipulation';
      });
    })();

    // expose some helpers to dev console for demo/testing
    window.RH5 = {
      addBooking, getBookings, seedInitialData, getSession, logout
    };

  </script>
</body>
</html>
