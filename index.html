<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH5 Trainer Booking System</title>
<style>
  body { font-family: sans-serif; background:#f9fafb; margin:0; padding:0; }
  .hidden { display:none; }
  .container { max-width:1200px; margin:auto; padding:1rem; }
  .card { background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:1rem; }
  button,input,select { font-size:1rem; padding:0.5rem; border-radius:4px; border:1px solid #ccc; }
  .status-dot { display:inline-block; width:12px; height:12px; border-radius:50%; margin-left:4px; }
  .chat-box { max-height:150px; overflow-y:auto; border:1px solid #ccc; padding:0.5rem; border-radius:4px; background:#fff; }
  #calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; text-align:center; }
  #calendar div { padding:8px; border-radius:4px; cursor:pointer; background:#f0f0f0; }
  #calendar div.weekend { background:#e0e0e0; }
  #booking-modal { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; }
  #booking-modal .modal-content { background:white; padding:1rem; border-radius:8px; width:100%; max-width:400px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- Login -->
<div id="login-page" class="container">
  <div class="card" style="max-width:400px;margin:auto;">
    <h1 style="text-align:center;">RH5 Trainer Booking System</h1>
    <input id="username" placeholder="Username" class="w-full mb-2"><br>
    <input id="password" placeholder="Password" type="password" class="w-full mb-2"><br>
    <select id="role" class="w-full mb-2">
      <option value="staff">Staff</option>
      <option value="lecturer">Lecturer</option>
      <option value="admin">Admin</option>
    </select><br>
    <button id="login-btn" class="w-full">Login</button>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard-page" class="container hidden">
  <div class="card">
    <h2 id="banner-text-display">RH5 Trainer Booking System</h2>
  </div>

  <!-- Summary -->
  <div id="summary-cards"></div>

  <!-- Calendar -->
  <div class="card">
    <h3>Calendar</h3>
    <div id="calendar"></div>
  </div>

  <button id="book-cta" class="mb-2">จองคิววิทยากร</button>

  <!-- User Management (Admin only) -->
  <div id="user-management" class="card hidden">
    <h3>User Management</h3>
    <button id="add-user-btn">เพิ่มผู้ใช้</button>
    <div id="user-list"></div>
  </div>

  <!-- Banner Management (Admin only) -->
  <div id="banner-management" class="card hidden">
    <h3>Banner Management</h3>
    <input id="banner-text" placeholder="ข้อความ banner" class="w-full mb-2"><br>
    <button id="save-banner-btn">บันทึก banner</button>
  </div>

  <!-- Live Chat -->
  <div class="card">
    <h3>Live Chat</h3>
    <div class="chat-box" id="chat-messages"></div>
    <input id="chat-input" placeholder="พิมพ์ข้อความ..." class="w-full mb-2">
    <button id="chat-send">ส่ง</button>
  </div>

  <!-- Invitation Card (Staff only) -->
  <div id="invitation-card" class="card hidden">
    <h3>Invitation PDF</h3>
    <select id="booking-select" class="w-full mb-2"></select><br>
    <button id="generate-invitation">ดาวน์โหลด PDF</button>
  </div>

</div>

<!-- Booking Modal -->
<div id="booking-modal" class="hidden">
  <div class="modal-content">
    <h3>สร้างการจอง</h3>
    <input type="date" id="booking-date" class="w-full mb-2">
    <input type="time" id="booking-start" class="w-full mb-2">
    <input type="time" id="booking-end" class="w-full mb-2">
    <input type="number" id="booking-attendees" placeholder="จำนวนผู้เข้าอบรม" class="w-full mb-2">
    <select id="booking-type" class="w-full mb-2">
      <option value="f2f">F2F</option>
      <option value="online">Online</option>
    </select>
    <div id="location-label" class="hidden">
      <input id="booking-location" placeholder="สถานที่" class="w-full mb-2">
    </div>
    <button id="booking-submit" class="mb-2">สร้างการจอง</button>
    <button id="booking-cancel">ยกเลิก</button>
  </div>
</div>

<script>
  // ========= Session =========
  function saveSession(user){ localStorage.setItem("session",JSON.stringify(user)); }
  function getSession(){ return JSON.parse(localStorage.getItem("session")); }
  function logout(){ localStorage.removeItem("session"); document.getElementById("dashboard-page").classList.add("hidden"); document.getElementById("login-page").classList.remove("hidden"); }

  // ========= Login =========
  document.getElementById("login-btn").onclick=function(){
    const username=document.getElementById("username").value;
    const password=document.getElementById("password").value;
    const role=document.getElementById("role").value;
    if(username&&password){ saveSession({username,role}); loadDashboard(); }
    else alert("กรุณากรอกข้อมูลให้ครบ");
  }

  // ========= Dashboard =========
  function loadDashboard(){
    const session=getSession(); if(!session) return;
    document.getElementById("login-page").classList.add("hidden");
    document.getElementById("dashboard-page").classList.remove("hidden");
    document.getElementById("user-management").classList.toggle("hidden",session.role!=="admin");
    document.getElementById("banner-management").classList.toggle("hidden",session.role!=="admin");
    document.getElementById("invitation-card").classList.toggle("hidden",session.role!=="staff");
    renderSummary(); renderCalendar(); renderUsers(); renderBanner(); renderChat(); renderBookingSelect();
  }

  // ========= Summary =========
  function renderSummary(){
    const cards=document.getElementById("summary-cards");
    cards.innerHTML="";
    const card1=document.createElement("div"); card1.className="card";
    card1.innerHTML="<h4>จำนวนงานที่รีเควส</h4>เดือนนี้:34<br>ปีนี้:120";
    const card2=document.createElement("div"); card2.className="card";
    card2.innerHTML="<h4>จำนวนผู้เข้าอบรม</h4>เดือนนี้:56<br>ปีนี้:210";
    cards.appendChild(card1); cards.appendChild(card2);
  }

  // ========= Calendar =========
  function renderCalendar(){
    const cal=document.getElementById("calendar"); cal.innerHTML="";
    const now=new Date(); const year=now.getFullYear(); const month=now.getMonth();
    const days=new Date(year,month+1,0).getDate();
    const bookings=JSON.parse(localStorage.getItem("bookings")||"[]");
    for(let i=1;i<=days;i++){
      const div=document.createElement("div"); div.innerText=i;
      const d=new Date(year,month,i).getDay(); if(d==0||d==6) div.classList.add("weekend");
      const b=bookings.find(x=>x.date===`${year}-${month+1}-${i}`);
      if(b) div.innerHTML+=` <span class="status-dot" style="background:${b.status==='approved'?'red':'yellow'}"></span>`;
      cal.appendChild(div);
    }
  }

  // ========= Booking =========
  const bookBtn=document.getElementById("book-cta");
  const modal=document.getElementById("booking-modal");
  const cancelBtn=document.getElementById("booking-cancel");
  const locationLabel=document.getElementById("location-label");
  bookBtn.onclick=()=>modal.classList.remove("hidden");
  cancelBtn.onclick=()=>modal.classList.add("hidden");
  document.getElementById("booking-type").onchange=function(){
    locationLabel.classList.toggle("hidden",this.value!=="f2f");
  }
  document.getElementById("booking-submit").onclick=function(){
    const date=document.getElementById("booking-date").value;
    const start=document.getElementById("booking-start").value;
    const end=document.getElementById("booking-end").value;
    const attendees=document.getElementById("booking-attendees").value;
    const type=document.getElementById("booking-type").value;
    const location=document.getElementById("booking-location").value;
    const bookings=JSON.parse(localStorage.getItem("bookings")||"[]");
    const conflict=bookings.some(b=>b.date===date && ((start>=b.start && start<b.end)||(end>b.start && end<=b.end)));
    if(conflict){ alert("วันและเวลานี้ไม่ว่าง"); return; }
    bookings.push({date,start,end,attendees,type,location,status:"approved"});
    localStorage.setItem("bookings",JSON.stringify(bookings)); modal.classList.add("hidden"); renderCalendar(); renderBookingSelect();
  }

  // ========= User Management =========
  function renderUsers(){
    const list=document.getElementById("user-list"); list.innerHTML="";
    const users=JSON.parse(localStorage.getItem("users")||"[]");
    users.forEach((u,i)=>{
      const div=document.createElement("div"); div.innerHTML=`${u.username} (${u.role}) <button onclick="editUser(${i})">แก้ไข</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById("add-user-btn").onclick=function(){
    const username=prompt("Username:"); const role=prompt("Role:");
    if(!username||!role) return;
    const users=JSON.parse(localStorage.getItem("users")||"[]");
    users.push({username,role}); localStorage.setItem("users",JSON.stringify(users)); renderUsers();
  }
  window.editUser=function(i){
    const users=JSON.parse(localStorage.getItem("users")||"[]");
    users[i].username=prompt("แก้ไข username:",users[i].username);
    users[i].role=prompt("แก้ไข role:",users[i].role);
    localStorage.setItem("users",JSON.stringify(users)); renderUsers();
  }

  // ========= Banner =========
  function renderBanner(){
    const text=localStorage.getItem("banner")||"RH5 Trainer Booking System";
    document.getElementById("banner-text-display").innerText=text;
    document.getElementById("banner-text").value=text;
  }
  document.getElementById("save-banner-btn").onclick=function(){
    const text=document.getElementById("banner-text").value;
    localStorage.setItem("banner",text); renderBanner();
  }

  // ========= Chat =========
  function renderChat(){
    const chat=JSON.parse(localStorage.getItem("chat")||"[]");
    document.getElementById("chat-messages").innerHTML=chat.map(c=>`${c.user}: ${c.text}`).join("<br>");
  }
  document.getElementById("chat-send").onclick=function(){
    const input=document.getElementById("chat-input"); const text=input.value; if(!text) return;
    const session=getSession(); const chat=JSON.parse(localStorage.getItem("chat")||"[]");
    chat.push({user:session.username,text}); localStorage.setItem("chat",JSON.stringify(chat)); input.value=""; renderChat();
  }

  // ========= Invitation PDF =========
  function renderBookingSelect(){
    const select=document.getElementById("booking-select"); select.innerHTML="";
    const bookings=JSON.parse(localStorage.getItem("bookings")||"[]");
    bookings.forEach((b,i)=>{
      const opt=document.createElement("option"); opt.value=i; opt.text=`${b.date} ${b.start}-${b.end}`;
      select.appendChild(opt);
    });
  }
  document.getElementById("generate-invitation").onclick=function(){
    const idx=document.getElementById("booking-select").value; if(idx==="") return;
    const bookings=JSON.parse(localStorage.getItem("bookings")||"[]"); const b=bookings[idx];
    const doc=new jsPDF(); doc.text(`Invitation\nDate: ${b.date}\nTime: ${b.start}-${b.end}\nAttendees: ${b.attendees}\nType: ${b.type}\nLocation: ${b.location}`,10,10); doc.save("invitation.pdf");
  }

  // ========= Init =========
  if(getSession()) loadDashboard();
</script>

</body>
</html>
