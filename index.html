<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RH5 Trainer booking system - Block as full-day</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --touch-min: 44px; }
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .touch-btn { min-height: var(--touch-min); padding-top: 10px; padding-bottom: 10px; }
    .day-cell { min-height: 72px; border-radius: 0.5rem; }
    .dot { width: 12px; height: 12px; border-radius: 9999px; display:inline-block; margin-left:6px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .modal-full { position: fixed; inset: 0; display: flex; align-items: flex-end; justify-content: center; z-index: 50; }
    .modal-card { width: 100%; border-top-left-radius: 16px; border-top-right-radius: 16px; max-height: 92vh; overflow:auto; }
    .sticky-cta { position: fixed; left: 0; right: 0; bottom: 0; z-index: 40; padding: 10px; background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,1)); backdrop-filter: blur(6px); }
    canvas { width: 100% !important; height: auto !important; }
    .weekend { background-color: #f8fafc; }
    .cal-nav-btn { min-width: 44px; min-height: 44px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; }
    .required::after { content:" *"; color:#dc2626; font-weight:600; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div class="max-w-3xl mx-auto p-4 pb-32">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-lg font-semibold">RH5 Trainer booking system</h1>
        <p class="text-xs text-slate-500">‡∏ö‡∏•‡πá‡∏≠‡∏Ñ = ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô, ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏±‡πâ‡∏ô = ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</p>
      </div>
      <div class="flex items-center gap-2">
        <div id="userArea" class="text-sm text-right"></div>
        <button id="logoutBtn" class="hidden bg-gray-200 text-slate-700 rounded-md px-3 touch-btn">Logout</button>
      </div>
    </header>

    <!-- Calendar -->
    <section class="bg-white rounded-lg shadow p-3 mb-4">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <button id="prevMonth" class="cal-nav-btn bg-slate-100 cal-btn touch-btn">‚Äπ</button>
          <div id="monthLabel" class="font-semibold text-sm"></div>
          <button id="nextMonth" class="cal-nav-btn bg-slate-100 cal-btn touch-btn">‚Ä∫</button>
        </div>
        <div class="text-xs text-slate-500">‡πÅ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
      </div>

      <div class="text-xs text-slate-600 mb-2 grid grid-cols-7 gap-1 text-center">
        <div class="font-semibold">‡∏≠‡∏≤</div><div class="font-semibold">‡∏à</div><div class="font-semibold">‡∏≠</div><div class="font-semibold">‡∏û</div><div class="font-semibold">‡∏û‡∏§</div><div class="font-semibold">‡∏®</div><div class="font-semibold">‡∏™</div>
      </div>

      <div id="calendar" class="calendar-grid"></div>

      <div class="mt-3 text-xs text-slate-600 flex flex-wrap gap-3">
        <div class="inline-flex items-center"><span class="dot bg-red-500"></span>&nbsp;üî¥ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</div>
        <div class="inline-flex items-center"><span class="dot bg-yellow-400"></span>&nbsp;üü° ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)</div>
        <div class="inline-flex items-center"><span class="dot bg-slate-400"></span>&nbsp;‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</div>
      </div>
    </section>

    <!-- Summary -->
    <section class="space-y-3">
      <div class="bg-white rounded-lg shadow p-3"><h3 class="font-medium mb-2">Total Bookings (by zone)</h3><canvas id="pieZones" height="180"></canvas></div>
      <div class="bg-white rounded-lg shadow p-3"><h3 class="font-medium mb-2">Bookings by Month</h3><canvas id="barMonth" height="160"></canvas></div>
      <div class="bg-white rounded-lg shadow p-3"><h3 class="font-medium mb-2">Bookings by Year</h3><canvas id="barYear" height="160"></canvas></div>
      <div class="bg-white rounded-lg shadow p-3"><h3 class="font-medium mb-3">Status Summary</h3>
        <div class="grid grid-cols-3 gap-2 text-center">
          <div class="p-3 rounded border"><div class="text-sm text-slate-500">Pending</div><div id="pendingCount" class="font-semibold text-slate-700 mt-1">0</div></div>
          <div class="p-3 rounded border"><div class="text-sm text-slate-500">Accepted</div><div id="acceptedCount" class="font-semibold text-green-600 mt-1">0</div></div>
          <div class="p-3 rounded border"><div class="text-sm text-slate-500">Rejected</div><div id="rejectedCount" class="font-semibold text-red-600 mt-1">0</div></div>
        </div>
      </div>
    </section>

    <footer class="mt-6 text-xs text-slate-500 pb-8">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage ‚Äî ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö</footer>
  </div>

  <!-- Sticky CTA -->
  <div class="sticky-cta">
    <div class="max-w-3xl mx-auto px-4">
      <div class="flex gap-3">
        <button id="ctaBooking" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md touch-btn">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£</button>
        <button id="btnViewFilters" class="w-12 bg-slate-100 rounded-md touch-btn">‚öôÔ∏è</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal-full hidden"><div class="modal-card bg-white rounded-t-lg shadow p-4">
    <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3><button id="loginClose" class="text-slate-500 touch-btn">‡∏õ‡∏¥‡∏î</button></div>
    <div class="space-y-3">
      <label class="text-xs text-slate-600">Username</label><input id="loginUser" class="w-full border rounded px-3 py-2" />
      <label class="text-xs text-slate-600">Password</label><input id="loginPass" type="password" class="w-full border rounded px-3 py-2" />
      <div class="flex justify-end gap-2 mt-2"><button id="loginCancel" class="px-4 py-2 touch-btn rounded border">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="loginSubmit" class="bg-indigo-600 text-white px-4 py-2 touch-btn rounded">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div>
      <div class="text-xs text-slate-500 pt-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: admin/admin123, staff1/staff123, lect1/lect123</div>
    </div>
  </div></div>

  <!-- Booking Modal (full form) -->
  <div id="bookingModal" class="modal-full hidden"><div class="modal-card bg-white rounded-t-lg shadow p-4">
    <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3><button id="bookingClose" class="text-slate-500 touch-btn">‡∏õ‡∏¥‡∏î</button></div>

    <form id="bookingForm" class="space-y-3">
      <div><label class="text-xs text-slate-600 required">‡πÄ‡∏£‡∏¥‡πà‡∏° (Start)</label><input id="startDateTime" type="datetime-local" class="w-full border rounded px-3 py-2" required /></div>
      <div><label class="text-xs text-slate-600 required">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (End)</label><input id="endDateTime" type="datetime-local" class="w-full border rounded px-3 py-2" required /></div>

      <div><label class="text-xs text-slate-600 required">Zone</label>
        <select id="zoneSelect" class="w-full border rounded px-3 py-2" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone --</option>
          <option value="‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ">‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ</option>
          <option value="‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ">‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option>
          <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
          <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
          <option value="‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£</option>
        </select>
      </div>

      <div><label class="text-xs text-slate-600">Participant Group</label>
        <div class="flex flex-wrap gap-2 mt-2">
          <label class="inline-flex items-center gap-2"><input type="checkbox" name="group" value="BM" class="h-4 w-4" /> <span class="text-sm">BM</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" name="group" value="CISA" class="h-4 w-4" /> <span class="text-sm">CISA</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" name="group" value="CFSA" class="h-4 w-4" /> <span class="text-sm">CFSA</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" name="group" value="Wealth" class="h-4 w-4" /> <span class="text-sm">Wealth</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" name="group" value="Other" class="h-4 w-4" /> <span class="text-sm">Other</span></label>
        </div>
      </div>

      <div><label class="text-xs text-slate-600">Training Type</label><div class="flex gap-3 mt-2">
        <label class="inline-flex items-center gap-2"><input type="radio" name="trainingType" value="F2F" checked class="h-4 w-4" /> <span class="text-sm">F2F</span></label>
        <label class="inline-flex items-center gap-2"><input type="radio" name="trainingType" value="Online" class="h-4 w-4" /> <span class="text-sm">Online</span></label>
      </div></div>

      <div><label class="text-xs text-slate-600 required">Topic</label><input id="topicInput" type="text" class="w-full border rounded px-3 py-2" required /></div>
      <div><label class="text-xs text-slate-600 required">Purpose / Details</label><textarea id="purposeInput" rows="4" class="w-full border rounded px-3 py-2" required></textarea></div>

      <div><label class="text-xs text-slate-600">Speaker</label>
        <select id="speakerSelect" class="w-full border rounded px-3 py-2"><option value="">None</option><option value="‡∏≠.‡∏≠‡∏≤‡∏£‡πå‡∏°">‡∏≠.‡∏≠‡∏≤‡∏£‡πå‡∏°</option><option value="‡∏≠.‡∏ü‡πâ‡∏≤">‡∏≠.‡∏ü‡πâ‡∏≤</option></select>
      </div>

      <div><label class="text-xs text-slate-600 required">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô</label><input id="contactName" type="text" class="w-full border rounded px-3 py-2" required /></div>
      <div><label class="text-xs text-slate-600">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label><input id="contactPosition" type="text" class="w-full border rounded px-3 py-2" /></div>
      <div><label class="text-xs text-slate-600 required">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="contactPhone" type="tel" class="w-full border rounded px-3 py-2" placeholder="0812345678" required /></div>

      <div id="statusRow"><label class="text-xs text-slate-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</label>
        <select id="statusSelect" class="w-full border rounded px-3 py-2"><option value="pending">Pending</option><option value="accepted">Accepted</option><option value="rejected">Rejected</option><option value="blocked">Blocked</option></select>
      </div>

      <div class="flex justify-end gap-2 mt-2"><button type="button" id="bookingCancel" class="px-4 py-2 touch-btn rounded border">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 touch-btn rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button></div>
    </form>
  </div></div>

  <!-- Filter Modal (simple) -->
  <div id="filterModal" class="modal-full hidden"><div class="modal-card bg-white rounded-t-lg shadow p-4">
    <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-semibold">‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå</h3><button id="filterClose" class="text-slate-500 touch-btn">‡∏õ‡∏¥‡∏î</button></div>
    <div class="space-y-3">
      <label class="text-xs text-slate-600">Zone</label>
      <select id="filterZone" class="w-full border rounded px-3 py-2"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option>‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ</option><option>‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option><option>‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option><option>‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option><option>‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£</option></select>
      <label class="text-xs text-slate-600">Status</label>
      <select id="filterStatus" class="w-full border rounded px-3 py-2"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="pending">Pending</option><option value="accepted">Accepted</option><option value="rejected">Rejected</option><option value="blocked">Blocked</option></select>
      <div class="flex justify-end"><button id="applyFilter" class="bg-indigo-600 text-white px-4 py-2 touch-btn rounded">‡πÉ‡∏ä‡πâ</button></div>
    </div>
  </div></div>

<script>
/* Keys and config */
const SESSION_KEY='rh5_session', USERS_KEY='rh5_users', BOOKINGS_KEY='rh5_bookings';
const AUTOLOGOUT_MINUTES = 30;
const ZONES = ['‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ','‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ','‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï','‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà','‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£'];

/* Helpers */
function seedInitialData(){
  if(!localStorage.getItem(USERS_KEY)){
    const users = [
      { username:'admin', password:'admin123', role:'admin', displayName:'Administrator' },
      { username:'staff1', password:'staff123', role:'staff', displayName:'Staff - Jintana' },
      { username:'lect1', password:'lect123', role:'lecturer', displayName:'Lecturer - Somsak' }
    ];
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }
  if(!localStorage.getItem(BOOKINGS_KEY)){
    const now = new Date();
    const yyyy=now.getFullYear(), mm=String(now.getMonth()+1).padStart(2,'0');
    const bookings = [
      { id:'b1', start:`${yyyy}-${mm}-05T10:00`, end:`${yyyy}-${mm}-05T13:00`, zone:'‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', groups:['BM'], trainingType:'F2F', topic:'Training A', purpose:'‡∏≠‡∏ö‡∏£‡∏° A', speaker:'‡∏≠.‡∏≠‡∏≤‡∏£‡πå‡∏°', contact:{name:'‡∏™‡∏≤‡∏¢‡∏ù‡∏ô',position:'AM',phone:'0812345001'}, status:'accepted', createdBy:'staff1' },
      { id:'b2', start:`${yyyy}-${mm}-12T13:00`, end:`${yyyy}-${mm}-12T15:00`, zone:'‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', groups:['Wealth'], trainingType:'Online', topic:'Workshop B', purpose:'Workshop B', speaker:'‡∏≠.‡∏ü‡πâ‡∏≤', contact:{name:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢',position:'BM',phone:'0812345002'}, status:'pending', createdBy:'lect1' },
      // blocked day (will block whole day regardless of time)
      { id:'blk1', start:`${yyyy}-${mm}-25T00:00`, end:`${yyyy}-${mm}-25T23:59`, zone:null, groups:[], trainingType:'F2F', topic:'Maintenance', purpose:'System maintenance', speaker:'', contact:{name:'Admin',position:'',phone:''}, status:'blocked', createdBy:'admin' }
    ];
    localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
  }
}

function getSession(){ const s = localStorage.getItem(SESSION_KEY); return s?JSON.parse(s):null; }
function saveSession(sess){ sess.lastActivity=Date.now(); sess.createdAt=sess.createdAt||Date.now(); localStorage.setItem(SESSION_KEY, JSON.stringify(sess)); updateUIForSession(); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); updateUIForSession(); }
function login(username,password){
  const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
  const u = users.find(x=>x.username===username && x.password===password);
  if(!u) return { ok:false, message:'‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
  const s = { username:u.username, role:u.role, displayName:u.displayName, createdAt:Date.now(), lastActivity:Date.now() };
  saveSession(s); return { ok:true, session:s };
}
function logout(){ clearSession(); showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö'); renderPublicView(); }
function touchSessionActivity(){ const s=getSession(); if(!s) return; s.lastActivity=Date.now(); localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
setInterval(()=>{ const s=getSession(); if(!s) return; const elapsed = Date.now() - (s.lastActivity||s.createdAt||Date.now()); if(elapsed > AUTOLOGOUT_MINUTES*60*1000){ logout(); showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ'); } }, 30*1000);
['click','touchstart','keydown'].forEach(ev=> window.addEventListener(ev, ()=> touchSessionActivity(), { passive:true }));

/* Booking storage */
function getBookings(){ return JSON.parse(localStorage.getItem(BOOKINGS_KEY) || '[]'); }
function saveBookings(arr){ localStorage.setItem(BOOKINGS_KEY, JSON.stringify(arr)); }
function addBookingObj(b){ const arr=getBookings(); b.id='b'+Math.random().toString(36).slice(2,9); arr.push(b); saveBookings(arr); refreshAll(); return b; }

/* Date helpers */
function toYMD(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function getDatesBetween(startISO, endISO){
  const s = new Date(startISO); const e = new Date(endISO);
  const dates = [];
  const cur = new Date(s.getFullYear(), s.getMonth(), s.getDate());
  const last = new Date(e.getFullYear(), e.getMonth(), e.getDate());
  while(cur <= last){ dates.push(toYMD(cur)); cur.setDate(cur.getDate()+1); }
  return dates;
}

/* Availability (NEW LOGIC)
   - Blocked booking (status='blocked') blocks entire date(s) for ALL zones
   - Any booking that exists on the same calendar date for the SAME zone makes that date unavailable for that zone
   - New booking request is rejected if any requested date is unavailable
*/
function checkAvailabilityByDate(startISO, endISO, zone){
  const requestedDates = getDatesBetween(startISO, endISO); // array of 'YYYY-MM-DD'
  const bookings = getBookings();
  for(const rd of requestedDates){
    for(const b of bookings){
      const bDates = getDatesBetween(b.start, b.end);
      // if b is blocked and covers rd -> unavailable globally
      if(b.status === 'blocked' && bDates.includes(rd)) return { ok:false, reason:`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${rd} ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô` };
      // if there is any booking in same zone on that date -> unavailable for that zone
      if(zone && b.zone === zone && bDates.includes(rd)) return { ok:false, reason:`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${rd} ‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô ${zone} ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà` };
    }
  }
  return { ok:true };
}

/* Calendar rendering */
let calendarDate = new Date();
function renderCalendar(){
  const cal = document.getElementById('calendar'); cal.innerHTML='';
  const year = calendarDate.getFullYear(); const month = calendarDate.getMonth();
  const first = new Date(year, month, 1); const last = new Date(year, month+1, 0);
  const startDay = first.getDay(); const daysInMonth = last.getDate();
  for(let i=0;i<startDay;i++){ const blank=document.createElement('div'); blank.className='bg-transparent p-1'; cal.appendChild(blank); }

  const bookings = getBookings();
  // map bookings to dates
  const bookingsByDate = {};
  for(const b of bookings){
    const bDates = getDatesBetween(b.start, b.end);
    for(const d of bDates){
      bookingsByDate[d] = bookingsByDate[d] || [];
      bookingsByDate[d].push(b);
    }
  }

  for(let d=1; d<=daysInMonth; d++){
    const dateObj = new Date(year, month, d);
    const ymd = toYMD(dateObj);
    const isWeekend = dateObj.getDay()===0 || dateObj.getDay()===6;
    const cell = document.createElement('div'); cell.className=`day-cell border p-2 flex flex-col justify-between ${isWeekend ? 'weekend' : 'bg-white'}`;
    const top=document.createElement('div'); top.className='flex items-center justify-between';
    const dayNum=document.createElement('div'); dayNum.className='font-medium text-sm'; dayNum.textContent=d; top.appendChild(dayNum);
    const entries = bookingsByDate[ymd] || [];
    const markers = document.createElement('div');
    const hasBlocked = entries.some(e=> e.status==='blocked');
    const hasBooking = entries.some(e=> ['accepted','pending','rejected'].includes(e.status));
    if(hasBlocked){ const dot=document.createElement('span'); dot.className='dot bg-yellow-400'; markers.appendChild(dot); }
    else if(hasBooking){ const dot=document.createElement('span'); dot.className='dot bg-red-500'; markers.appendChild(dot); }
    top.appendChild(markers); cell.appendChild(top);

    const mid=document.createElement('div'); mid.className='text-xs text-slate-600 mt-2 flex-1';
    if(entries.length===0) mid.textContent='‡∏ß‡πà‡∏≤‡∏á';
    else {
      entries.slice(0,2).forEach(e=>{
        const row=document.createElement('div'); row.className='flex items-center gap-2';
        row.innerHTML = `<span class="${e.status==='accepted'?'text-green-600':(e.status==='rejected'?'text-red-600':'text-slate-700')} text-xs font-semibold truncate-2">${e.topic}</span><span class="text-xs text-slate-400">(${e.zone||'‚Äî'})</span>`;
        mid.appendChild(row);
      });
      if(entries.length>2){ const more=document.createElement('div'); more.className='text-xs text-slate-400'; more.textContent=`+${entries.length-2} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; mid.appendChild(more); }
    }
    cell.appendChild(mid);
    cell.addEventListener('click', ()=> showDateDetails(ymd));
    cal.appendChild(cell);
  }
  document.getElementById('monthLabel').textContent = calendarDate.toLocaleString('th-TH', { month:'long', year:'numeric' });
}

/* show details */
function showDateDetails(ymd){
  const bookings = getBookings().filter(b => getDatesBetween(b.start,b.end).includes(ymd));
  if(bookings.length===0){ alert(`${ymd}\n\n‡∏ß‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á`); return; }
  let msg=`${ymd}\n\n`;
  bookings.forEach(b => { msg += `‚Ä¢ ${b.topic} ‚Äî ${b.zone||'ALL'} ‚Äî ${b.start.replace('T',' ')} ‚Üí ${b.end.replace('T',' ')} ‚Äî ${b.status} (by ${b.createdBy})\n`; });
  alert(msg);
}

/* calendar nav */
document.getElementById('prevMonth').addEventListener('click', ()=> { calendarDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth()-1, 1); renderCalendar(); refreshCharts(); });
document.getElementById('nextMonth').addEventListener('click', ()=> { calendarDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth()+1, 1); renderCalendar(); refreshCharts(); });

/* Charts (same as before) */
let pieChart=null, barMonthChart=null, barYearChart=null;
function refreshCharts(){
  const bookings = getBookings();
  const zoneCounts = {}; ZONES.forEach(z=> zoneCounts[z]=0);
  bookings.filter(b=>b.zone).forEach(b=> { if(zoneCounts[b.zone]!==undefined) zoneCounts[b.zone]++; else zoneCounts[b.zone]=(zoneCounts[b.zone]||0)+1; });
  const pieLabels = Object.keys(zoneCounts), pieData = pieLabels.map(l=>zoneCounts[l]);
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(document.getElementById('pieZones').getContext('2d'), { type:'pie', data:{ labels:pieLabels, datasets:[{ data:pieData }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });

  const curY = calendarDate.getFullYear(), curM = calendarDate.getMonth();
  const daysInMonth = new Date(curY,curM+1,0).getDate();
  const dailyCounts = new Array(daysInMonth).fill(0);
  bookings.forEach(b => { const s=new Date(b.start); if(s.getFullYear()===curY && s.getMonth()===curM) dailyCounts[s.getDate()-1]++; });
  const labels = dailyCounts.map((_,i)=> String(i+1));
  if(barMonthChart) barMonthChart.destroy();
  barMonthChart = new Chart(document.getElementById('barMonth').getContext('2d'), { type:'bar', data:{ labels, datasets:[{ label:'Bookings', data:dailyCounts }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ display:false } } } });

  const year = (new Date()).getFullYear();
  const monthlyCounts = new Array(12).fill(0);
  bookings.forEach(b => { const s=new Date(b.start); if(s.getFullYear()===year) monthlyCounts[s.getMonth()]++; });
  const monthLabels = ['‡∏°.‡∏Ñ','‡∏Å.‡∏û','‡∏°‡∏µ.‡∏Ñ','‡πÄ‡∏°.‡∏¢','‡∏û.‡∏Ñ','‡∏°‡∏¥.‡∏¢','‡∏Å.‡∏Ñ','‡∏™.‡∏Ñ','‡∏Å.‡∏¢','‡∏ï.‡∏Ñ','‡∏û.‡∏¢','‡∏ò.‡∏Ñ'];
  if(barYearChart) barYearChart.destroy();
  barYearChart = new Chart(document.getElementById('barYear').getContext('2d'), { type:'bar', data:{ labels:monthLabels, datasets:[{ label:'Bookings', data:monthlyCounts }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ display:false } } } });

  document.getElementById('pendingCount').textContent = bookings.filter(b=>b.status==='pending').length;
  document.getElementById('acceptedCount').textContent = bookings.filter(b=>b.status==='accepted').length;
  document.getElementById('rejectedCount').textContent = bookings.filter(b=>b.status==='rejected').length;
}

/* UI and form handling */
function updateUIForSession(){
  const s = getSession(); const userArea=document.getElementById('userArea'); const logoutBtn=document.getElementById('logoutBtn'); const cta=document.getElementById('ctaBooking');
  if(s){ userArea.innerHTML=`<div class="text-sm">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${s.displayName}</div><div class="text-xs text-slate-500">${s.role}</div>`; logoutBtn.classList.remove('hidden'); cta.textContent='‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á'; cta.onclick = openBookingForm; }
  else { userArea.innerHTML=`<div class="text-sm text-slate-600">‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°</div>`; logoutBtn.classList.add('hidden'); cta.textContent='‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£'; cta.onclick = showLoginModal; }
}

function showLoginModal(){ document.getElementById('loginModal').classList.remove('hidden'); document.getElementById('loginUser').focus(); }
function hideLoginModal(){ document.getElementById('loginModal').classList.add('hidden'); document.getElementById('loginUser').value=''; document.getElementById('loginPass').value=''; }
document.getElementById('loginClose').addEventListener('click', hideLoginModal);
document.getElementById('loginCancel').addEventListener('click', hideLoginModal);
document.getElementById('loginSubmit').addEventListener('click', ()=>{ const u=document.getElementById('loginUser').value.trim(); const p=document.getElementById('loginPass').value; if(!u||!p){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return;} const r=login(u,p); if(!r.ok) showToast(r.message); else { hideLoginModal(); showToast('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); updateUIForSession(); } });
document.getElementById('logoutBtn').addEventListener('click', ()=> logout());

/* Booking form open/close */
function openBookingForm(){
  const sess = getSession(); if(!sess){ showLoginModal(); return; }
  const now=new Date(); const yyyy=now.getFullYear(), mm=String(now.getMonth()+1).padStart(2,'0'), dd=String(now.getDate()).padStart(2,'0');
  document.getElementById('startDateTime').value = `${yyyy}-${mm}-${dd}T09:00`;
  document.getElementById('endDateTime').value = `${yyyy}-${mm}-${dd}T10:00`;
  document.getElementById('zoneSelect').value = '';
  document.querySelectorAll('input[name="group"]').forEach(i=> i.checked=false);
  document.querySelectorAll('input[name="trainingType"]').forEach(i=> i.checked = (i.value==='F2F'));
  document.getElementById('topicInput').value=''; document.getElementById('purposeInput').value=''; document.getElementById('speakerSelect').value=''; document.getElementById('contactName').value=''; document.getElementById('contactPosition').value=''; document.getElementById('contactPhone').value='';
  const statusSel=document.getElementById('statusSelect'); if(sess.role==='admin'){ statusSel.removeAttribute('disabled'); statusSel.value='pending'; } else { statusSel.value='pending'; statusSel.setAttribute('disabled','disabled'); }
  document.getElementById('bookingModal').classList.remove('hidden');
}
function closeBookingForm(){ document.getElementById('bookingModal').classList.add('hidden'); document.getElementById('statusSelect').removeAttribute('disabled'); }
document.getElementById('bookingClose').addEventListener('click', closeBookingForm);
document.getElementById('bookingCancel').addEventListener('click', closeBookingForm);

/* Booking submit with DATE-LEVEL availability check */
document.getElementById('bookingForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const sess = getSession(); if(!sess){ showLoginModal(); closeBookingForm(); return; }
  const start = document.getElementById('startDateTime').value;
  const end = document.getElementById('endDateTime').value;
  const zone = document.getElementById('zoneSelect').value || null;
  const groups = Array.from(document.querySelectorAll('input[name="group"]:checked')).map(i=>i.value);
  const trainingType = document.querySelector('input[name="trainingType"]:checked')?.value || 'F2F';
  const topic = document.getElementById('topicInput').value.trim();
  const purpose = document.getElementById('purposeInput').value.trim();
  const speaker = document.getElementById('speakerSelect').value || '';
  const contactName = document.getElementById('contactName').value.trim();
  const contactPosition = document.getElementById('contactPosition').value.trim();
  const contactPhone = document.getElementById('contactPhone').value.trim();
  let status = document.getElementById('statusSelect').value || 'pending';

  // validation
  if(!start || !end){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤'); return; }
  const s = new Date(start), en = new Date(end);
  if(s.toString()==='Invalid Date' || en.toString()==='Invalid Date'){ showToast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
  if(s >= en){ showToast('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
  const startHour = s.getHours() + s.getMinutes()/60;
  const endHour = en.getHours() + en.getMinutes()/60;
  if(startHour < 9 || endHour > 18){ showToast('‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 09:00 - 18:00'); return; }
  if(!topic){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'); return; }
  if(!purpose){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå'); return; }
  if(!contactName || !contactPhone){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô (‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)'); return; }
  if(!/^\d{7,15}$/.test(contactPhone)){ showToast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô 7-15 ‡∏ï‡∏±‡∏ß)'); return; }
  // new availability: date-level
  const avail = checkAvailabilityByDate(start, end, zone);
  if(!avail.ok){ showToast(avail.reason); return; }
  if(sess.role !== 'admin') status = 'pending';

  const booking = { start, end, zone, groups, trainingType, topic, purpose, speaker, contact:{name:contactName,position:contactPosition,phone:contactPhone}, status, createdBy: sess.username };
  addBookingObj(booking);
  showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (status: ' + status + ')');
  closeBookingForm();
});

/* Filters */
document.getElementById('btnViewFilters').addEventListener('click', ()=> document.getElementById('filterModal').classList.remove('hidden'));
document.getElementById('filterClose').addEventListener('click', ()=> document.getElementById('filterModal').classList.add('hidden'));
document.getElementById('applyFilter').addEventListener('click', ()=> { document.getElementById('filterModal').classList.add('hidden'); showToast('Applied filter (demo)'); });

/* Toast */
function showToast(msg, ms=3000){ const t=document.createElement('div'); t.className='fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded shadow'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=> t.remove(), ms); }

/* Init */
(function init(){ seedInitialData(); calendarDate=new Date(); checkSessionOnLoad(); if(!getSession()) renderPublicView(); document.querySelectorAll('button,input,select,textarea').forEach(el=> el.style.touchAction='manipulation'); })();

function checkSessionOnLoad(){
  const s = getSession(); if(!s){ renderPublicView(); return; }
  const elapsed = Date.now() - (s.lastActivity || s.createdAt || Date.now());
  if(elapsed > AUTOLOGOUT_MINUTES*60*1000){ clearSession(); renderPublicView(); showToast('Session ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤'); }
  else { s.lastActivity = Date.now(); localStorage.setItem(SESSION_KEY, JSON.stringify(s)); routeToRoleDashboard(s.role); }
}

function renderPublicView(){ document.getElementById('ctaBooking').onclick = showLoginModal; document.getElementById('logoutBtn').classList.add('hidden'); updateUIForSession(); refreshAll(); }
function routeToRoleDashboard(role){ showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ' + role, 1200); updateUIForSession(); refreshAll(); }
function refreshAll(){ renderCalendar(); refreshCharts(); updateUIForSession(); }

/* Expose for debugging */
window.RH5 = { getBookings, addBookingObj, getSession, logout };

</script>
</body>
</html>
