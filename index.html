<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>RH5 Trainer Booking System</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:#f8fafc;color:#1e293b;}
  .touch-btn{min-height:44px;padding:10px;}
  .day-cell{min-height:72px;border-radius:.5rem;}
  .dot{width:12px;height:12px;border-radius:9999px;display:inline-block;margin-left:6px;}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
  .modal-full{position:fixed;inset:0;display:flex;align-items:flex-end;justify-content:center;z-index:50;}
  .modal-card{width:100%;border-top-left-radius:16px;border-top-right-radius:16px;max-height:92vh;overflow:auto;background:#fff;}
  .sticky-cta{position:fixed;left:0;right:0;bottom:0;z-index:40;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.6),#fff);backdrop-filter:blur(6px);}
  canvas{width:100% !important;height:auto !important;}
  .weekend{background-color:#f1f5f9;}
  .cal-nav-btn{min-width:44px;min-height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;}
  .required::after{content:" *";color:#dc2626;font-weight:600;}
</style>
</head>
<body>
<div class="max-w-3xl mx-auto p-4 pb-32">
  <header class="flex justify-between items-center mb-4">
    <div>
      <h1 class="text-lg font-semibold">RH5 Trainer Booking System</h1>
      <p class="text-xs text-slate-500">บล็อค=ทั้งวัน, การจองสั้น=วันนั้นไม่ว่าง</p>
    </div>
    <div class="flex gap-2 items-center">
      <div id="userArea" class="text-sm"></div>
      <button id="logoutBtn" class="hidden bg-gray-200 text-slate-700 rounded-md px-3 touch-btn">Logout</button>
    </div>
  </header>

  <!-- Dashboard -->
  <section class="space-y-3 mb-4">
    <!-- Card 1: Pie by zone -->
    <div class="bg-white rounded-lg shadow p-3">
      <h3 class="font-medium mb-2">สัดส่วนการจองตามโซน (เดือนปัจจุบัน)</h3>
      <div class="flex gap-4 flex-wrap">
        <canvas id="pieZones" class="flex-1" height="180"></canvas>
        <div id="pieLegend" class="flex-1 text-sm"></div>
      </div>
    </div>
    <!-- Card 2: Total bookings -->
    <div class="bg-white rounded-lg shadow p-3 grid grid-cols-2 gap-2">
      <div class="p-3 bg-slate-50 rounded text-center">
        <div class="text-slate-500 text-sm">Bookings This Month</div>
        <div id="totalMonth" class="text-xl font-semibold mt-1">0</div>
      </div>
      <div class="p-3 bg-slate-50 rounded text-center">
        <div class="text-slate-500 text-sm">Bookings This Year</div>
        <div id="totalYear" class="text-xl font-semibold mt-1">0</div>
      </div>
    </div>
    <!-- Card 3: Total participants -->
    <div class="bg-white rounded-lg shadow p-3 grid grid-cols-2 gap-2">
      <div class="p-3 bg-slate-50 rounded text-center">
        <div class="text-slate-500 text-sm">Participants This Month</div>
        <div id="participantsMonth" class="text-xl font-semibold mt-1">0</div>
      </div>
      <div class="p-3 bg-slate-50 rounded text-center">
        <div class="text-slate-500 text-sm">Participants This Year</div>
        <div id="participantsYear" class="text-xl font-semibold mt-1">0</div>
      </div>
    </div>
  </section>

  <!-- Calendar -->
  <section class="bg-white rounded-lg shadow p-3 mb-4">
    <div class="flex justify-between items-center mb-2">
      <div class="flex items-center gap-2">
        <button id="prevMonth" class="cal-nav-btn bg-slate-100 touch-btn">‹</button>
        <div id="monthLabel" class="font-semibold text-sm"></div>
        <button id="nextMonth" class="cal-nav-btn bg-slate-100 touch-btn">›</button>
      </div>
      <div class="text-xs text-slate-500">แตะวันที่เพื่อดูรายละเอียด</div>
    </div>
    <div class="text-xs text-slate-600 mb-2 grid grid-cols-7 gap-1 text-center font-semibold">
      <div>อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div>ส</div>
    </div>
    <div id="calendar" class="calendar-grid"></div>
    <div class="mt-3 text-xs text-slate-600 flex flex-wrap gap-3">
      <div class="inline-flex items-center"><span class="dot bg-red-500"></span>ไม่ว่าง</div>
      <div class="inline-flex items-center"><span class="dot bg-yellow-400"></span>บล็อค (ทั้งวัน)</div>
      <div class="inline-flex items-center"><span class="dot bg-slate-400"></span>เสาร์-อาทิตย์</div>
    </div>
  </section>

  <!-- Sticky CTA -->
  <div class="sticky-cta">
    <div class="max-w-3xl mx-auto px-4">
      <div class="flex gap-3">
        <button id="ctaBooking" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md touch-btn">จองคิววิทยากร</button>
        <button id="btnViewFilters" class="w-12 bg-slate-100 rounded-md touch-btn">⚙️</button>
      </div>
    </div>
  </div>
</div>

<script>
// ====================== DATA & SESSION ======================
const SESSION_KEY='rh5_session', USERS_KEY='rh5_users', BOOKINGS_KEY='rh5_bookings';
const AUTOLOGOUT_MINUTES=30;
const ZONES=['ราชบุรี','สุราษฎร์ธานี','ภูเก็ต','หาดใหญ่','สมุทรสาคร'];

// seed users & bookings
function seedData(){
  if(!localStorage.getItem(USERS_KEY)){
    const users=[
      {username:'admin',password:'admin123',role:'admin',displayName:'Administrator'},
      {username:'staff1',password:'staff123',role:'staff',displayName:'Staff Jintana'},
      {username:'lect1',password:'lect123',role:'lecturer',displayName:'Lecturer Somsak'}
    ];
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }
  if(!localStorage.getItem(BOOKINGS_KEY)){
    const now=new Date(); const yyyy=now.getFullYear(); const mm=String(now.getMonth()+1).padStart(2,'0');
    const bookings=[
      {id:'b1',start:`${yyyy}-${mm}-05T10:00`,end:`${yyyy}-${mm}-05T13:00`,zone:'ราชบุรี',groups:['BM'],trainingType:'F2F',topic:'Training A',purpose:'อบรม A',speaker:'อ.อาร์ม',contact:{name:'สายฝน',position:'AM',phone:'0812345001'},status:'accepted',createdBy:'staff1',participants:10},
      {id:'blk1',start:`${yyyy}-${mm}-25T00:00`,end:`${yyyy}-${mm}-25T23:59`,zone:null,groups:[],trainingType:'F2F',topic:'Maintenance',purpose:'System maintenance',speaker:'',contact:{name:'Admin',position:'',phone:''},status:'blocked',createdBy:'admin',participants:0}
    ];
    localStorage.setItem(BOOKINGS_KEY, JSON.stringify(bookings));
  }
}
seedData();
function getBookings
